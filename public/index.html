<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASCII ART Studio - Create & Mint</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#000;color:#0f0;font-family:'Inter',sans-serif;padding:20px}
    .container{max-width:800px;margin:auto}
    header{display:flex;justify-content:space-between;align-items:center;padding:20px 0;border-bottom:1px solid #0f0}
    .logo{font-size:24px;font-weight:600}
    .connect-btn{background:#0f0;color:#000;padding:10px 20px;border:none;cursor:pointer;font-weight:600}
    .hero{text-align:center;padding:40px 0}
    .hero h1{font-size:36px;margin-bottom:16px}
    .hero p{font-size:18px;opacity:.8}
    .token-info{text-align:center;padding:20px;background:#111;margin:20px 0;border:1px solid #0f0}
    .editor{margin:30px 0}
    textarea{width:100%;height:200px;background:#111;color:#0f0;border:1px solid #0f0;padding:16px;font-family:'JetBrains Mono',monospace;font-size:14px}
    .buy-btn{background:#0f0;color:#000;padding:16px;width:100%;border:none;font-size:18px;font-weight:600;cursor:pointer;margin-top:16px}
    .buy-btn:disabled{background:#333;cursor:not-allowed}
    .gallery{margin-top:40px}
    .gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-top:20px}
    .gallery-item{background:#111;border:1px solid #0f0;padding:16px;font-family:'JetBrains Mono',monospace;font-size:12px;white-space:pre;overflow:auto}
    .social{text-align:center;margin:40px 0}
    .social a{color:#0f0;text-decoration:none;font-weight:600}
  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo">ASCIIx402</div>
    <button id="connectBtn" class="connect-btn">Connect Phantom</button>
  </header>

  <div class="hero">
    <h1>Create ASCII Art NFTs</h1>
    <p>Turn your ASCII art into verified x402 NFTs. Pay 0.001 SOL and mint instantly.</p>
  </div>

  <div class="token-info" id="tokenInfo">Loading live data...</div>

  <div id="walletSection"></div>

  <div class="editor">
    <textarea id="asciiInput" placeholder="Paste your ASCII art here..."></textarea>
    <button id="buyBtn" class="buy-btn" disabled>Pay 0.001 SOL & Create NFT</button>
    <div id="result"></div>
  </div>

  <div class="gallery">
    <h2>Community Gallery</h2>
    <div class="gallery-grid" id="gallery"></div>
  </div>

  <div class="social">
    <a href="https://x.com/TU_USUARIO_X" target="_blank">Follow on X</a>
  </div>
</div>

<script>
  const connectBtn = document.getElementById('connectBtn');
  const walletSection = document.getElementById('walletSection');
  const asciiInput = document.getElementById('asciiInput');
  const buyBtn = document.getElementById('buyBtn');
  const result = document.getElementById('result');
  const tokenInfo = document.getElementById('tokenInfo');
  const gallery = document.getElementById('gallery');

  let wallet = null;
  let provider = null;

  connectBtn.onclick = async () => {
    if (window.solana?.isPhantom) {
      provider = window.solana;
      try {
        await provider.connect();
        wallet = provider.publicKey.toString();
        walletSection.innerHTML = `<p>Connected: ${wallet.slice(0,6)}...${wallet.slice(-4)}</p>`;
        connectBtn.textContent = 'Connected';
        connectBtn.disabled = true;
        buyBtn.disabled = false;
      } catch { alert('Connection failed'); }
    } else alert('Install Phantom Wallet');
  };

  async function loadTokenInfo() {
    try {
      const r = await fetch('/api/token-info');
      const d = await r.json();
      tokenInfo.innerHTML = `${d.ticker} • MC: ${d.marketCap} • Price: ${d.price}`;
    } catch { tokenInfo.innerHTML = 'API Error'; }
  }

  async function loadGallery() {
    try {
      const r = await fetch('/api/gallery');
      const arts = await r.json();
      gallery.innerHTML = arts.map(a => `<div class="gallery-item">${a.ascii.replace(/</g, '&lt;')}</div>`).join('');
    } catch { gallery.innerHTML = '<p>No art yet</p>'; }
  }

  buyBtn.onclick = async () => {
    if (!wallet) return;
    const ascii = asciiInput.value.trim();
    if (!ascii) return alert('Paste ASCII art');

    buyBtn.disabled = true;
    buyBtn.textContent = 'Processing...';

    try {
      const r = await fetch('/api/buy-and-save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ascii, wallet })
      });
      const d = await r.json();

      if (d.success) {
        result.innerHTML = '<p>NFT created!</p>';
        loadGallery();
        setTimeout(() => location.href = d.downloadUrl, 1000);
      } else {
        result.innerHTML = `<p style="color:#f00">${d.error}</p>`;
      }
    } catch (e) {
      result.innerHTML = `<p style="color:#f00">Network error</p>`;
    } finally {
      buyBtn.disabled = false;
      buyBtn.textContent = 'Pay 0.001 SOL & Create NFT';
    }
  };

  loadTokenInfo();
  loadGallery();
  setInterval(loadTokenInfo, 15000);
</script>
</body>
</html>