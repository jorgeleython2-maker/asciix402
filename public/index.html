<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ASCII ART Studio - Create & Mint</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@solana/web3.js@1.91.7/lib/index.iife.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#000; color:#0f0; font-family:'Inter',sans-serif; padding:20px; }
    .container { max-width:800px; margin:auto; }
    header { display:flex; justify-content:space-between; align-items:center; padding:20px 0; border-bottom:1px solid #0f0; }
    .logo { font-size:24px; font-weight:600; }
    .connect-btn { background:#0f0; color:#000; padding:10px 20px; border:none; cursor:pointer; font-weight:600; }
    .hero { text-align:center; padding:40px 0; }
    .hero h1 { font-size:36px; margin-bottom:16px; }
    .hero p { font-size:18px; opacity:0.8; }
    .token-info { text-align:center; padding:20px; background:#111; margin:20px 0; border:1px solid #0f0; }
    .editor { margin:30px 0; }
    textarea { width:100%; height:200px; background:#111; color:#0f0; border:1px solid #0f0; padding:16px; font-family:'JetBrains Mono',monospace; font-size:14px; }
    .buy-btn { background:#0f0; color:#000; padding:16px; width:100%; border:none; font-size:18px; font-weight:600; cursor:pointer; margin-top:16px; }
    .buy-btn:disabled { background:#333; cursor:not-allowed; }
    .result { margin-top:16px; padding:16px; background:#111; border:1px solid #0f0; }
    .gallery { margin-top:40px; }
    .gallery-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:16px; margin-top:20px; }
    .gallery-item { background:#111; border:1px solid #0f0; padding:16px; font-family:'JetBrains Mono',monospace; font-size:12px; white-space:pre; overflow:auto; }
    .social { text-align:center; margin:40px 0; }
    .social a { color:#0f0; text-decoration:none; font-weight:600; }
    .error { color:#f00; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">ASCIIx402</div>
      <button id="connectBtn" class="connect-btn">Connect Phantom</button>
    </header>

    <div class="hero">
      <h1>Create ASCII Art NFTs</h1>
      <p>Turn your ASCII art into verified x402 NFTs. Pay 0.001 SOL and mint instantly.</p>
    </div>

    <div class="token-info" id="tokenInfo">Loading live data...</div>

    <div id="walletSection"></div>

    <div class="editor">
      <textarea id="asciiInput" placeholder="Paste your ASCII art here..."></textarea>
      <button id="buyBtn" class="buy-btn" disabled>Pay 0.001 SOL & Create NFT</button>
      <div id="result"></div>
    </div>

    <div class="gallery">
      <h2>Community Gallery</h2>
      <div class="gallery-grid" id="gallery"></div>
    </div>

    <div class="social">
      <a href="https://x.com/TU_USUARIO_X" target="_blank">Follow on X</a>
    </div>
  </div>

  <script>
    const connectBtn = document.getElementById('connectBtn');
    const walletSection = document.getElementById('walletSection');
    const asciiInput = document.getElementById('asciiInput');
    const buyBtn = document.getElementById('buyBtn');
    const result = document.getElementById('result');
    const tokenInfo = document.getElementById('tokenInfo');
    const gallery = document.getElementById('gallery');

    let wallet = null;
    let provider = null;

    connectBtn.onclick = async () => {
      if (window.solana?.isPhantom) {
        provider = window.solana;
        try {
          await provider.connect();
          wallet = provider.publicKey.toString();
          walletSection.innerHTML = `<p>Connected: ${wallet.slice(0,6)}...${wallet.slice(-4)}</p>`;
          connectBtn.textContent = 'Connected';
          connectBtn.disabled = true;
          buyBtn.disabled = false;
        } catch (err) {
          alert('Connection failed: ' + err.message);
        }
      } else {
        alert('Install Phantom: https://phantom.app');
      }
    };

    async function loadTokenInfo() {
      try {
        const res = await fetch('/api/token-info');
        const data = await res.json();
        tokenInfo.innerHTML = `${data.ticker} • MC: ${data.marketCap} • Price: ${data.price}`;
      } catch {
        tokenInfo.innerHTML = 'API Error';
      }
    }

    async function loadGallery() {
      try {
        const res = await fetch('/api/gallery');
        const arts = await res.json();
        gallery.innerHTML = arts.map(a => `<div class="gallery-item">${a.ascii.replace(/</g, '&lt;')}</div>`).join('');
      } catch {
        gallery.innerHTML = '<p>No art yet</p>';
      }
    }

    buyBtn.onclick = async () => {
      if (!wallet) return alert('Connect wallet first');
      const ascii = asciiInput.value.trim();
      if (!ascii) return alert('Paste ASCII art');

      buyBtn.disabled = true;
      buyBtn.textContent = 'Generating TX...';

      try {
        const res = await fetch('/api/buy-and-save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ascii, wallet })
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error);

        const txBytes = Uint8Array.from(atob(data.txBase64).split('').map(c => c.charCodeAt(0)));
        const tx = solanaWeb3.VersionedTransaction.deserialize(txBytes);

        buyBtn.textContent = 'Sign in Phantom...';
        const signedTx = await provider.signTransaction(tx);
        const serializedTx = signedTx.serialize();

        buyBtn.textContent = 'Sending TX...';
        const rpcRes = await fetch('https://api.mainnet-beta.solana.com', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            jsonrpc: '2.0',
            id: 1,
            method: 'sendTransaction',
            params: [Buffer.from(serializedTx).toString('base64')]
          })
        });
        const rpcData = await rpcRes.json();
        if (rpcData.error) throw new Error(rpcData.error.message);

        // GUARDAR TX FIRMADA
        await fetch('/api/save-tx', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: data.id, tx: rpcData.result })
        });

        result.innerHTML = `
          <p>Success!</p>
          <p>TX: <a href="https://solscan.io/tx/${rpcData.result}" target="_blank">${rpcData.result.slice(0,8)}...</a></p>
        `;
        loadGallery();

        setTimeout(() => {
          location.href = `/api/download?id=${data.id}&format=txt`;
        }, 1500);

      } catch (err) {
        result.innerHTML = `<p class="error">Error: ${err.message}</p>`;
      } finally {
        buyBtn.disabled = false;
        buyBtn.textContent = 'Pay 0.001 SOL & Create NFT';
      }
    };

    loadTokenInfo();
    loadGallery();
    setInterval(loadTokenInfo, 15000);
  </script>
</body>
</html>